<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Friends List</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="main">
      <div class="leftContainer">
        <div class="leftContainerHeader">
          <div class="leftContainerHeaderDropDown">
            <button class="leftContainerHeaderDropDownBtn">
              <img src="Vector.png" alt="" class="leftContainerHeaderBtnIcon" />
            </button>
            <div class="leftContainerHeaderDropDownContent">
              <div class="leftContainerHeaderDropDownUserInfor">
                <img id="avatar" class="avatar" src="" alt="" />
                <h3 id="fullName"></h3>
              </div>
              <a href="">
                <img
                  src="@.png"
                  alt=""
                  class="leftContainerHeaderDropDownIcon"
                />
                Nhắc đến bạn
              </a>
              <a href="">
                <img
                  src="group.png"
                  alt=""
                  class="leftContainerHeaderDropDownIcon"
                />
                Tạo nhóm
              </a>
              <a href="">
                <img
                  src="moon.png"
                  alt=""
                  class="leftContainerHeaderDropDownIcon"
                />
                Giao diện tối
              </a>
              <a id="logout" href="">
                <img
                  src="user.png"
                  alt=""
                  class="leftContainerHeaderDropDownIcon"
                />
                Đăng xuất
              </a>
            </div>
          </div>

          <div class="leftContainerHeaderSearch">
            <img src="Shape.png" alt="" class="leftContainerHeaderSearchIcon" />
            <input
              class="leftContainerHeaderSearchInput"
              type="text"
              name=""
              id=""
              placeholder="Tìm kiếm"
            />
          </div>
        </div>
        <div class="leftContainerChannels">
          <div id="friends">
            <!-- <img src="Profile pic.png" alt="">
                    <div class="leftContainerChannelInfor">
                        <p class="content">Elon</p>
                        <p class="content">Mouse hover button</p>
                    </div> -->
          </div>
        </div>
      </div>
      <div class="rightContainer">
        <div id="getUser"></div>
        <div class="rightContainerListMessage">
          <div id="messages"></div>
        </div>
        <div class="rightContainerMessageComposer">
          <button class="rightContainerMessageComposerPlus">
            <img
              src="attach.png"
              alt=""
              class="rightContainerMessageComposerPlusIcon"
            />
          </button>
          <div class="rightContainerMessageComposerEnter">
            <input
              class="rightContainerMessageComposerEnterInput"
              type="text"
              name=""
              id=""
              placeholder="Nhập tin nhắn"
            />
            <button class="rightContainerMessageComposerEnterEmo">
              <img
                src="smile.png"
                alt=""
                class="rightContainerMessageComposerEnterEmoIcon"
              />
            </button>
          </div>
          <button class="rightContainerMessageComposerSend">
            <img
              src="Send Button.png"
              alt=""
              class="rightContainerMessageComposerSendIcon"
            />
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
<script>
  const token = localStorage.getItem("token");
  const friendsList = document.getElementById("friends");
  const getUser = document.getElementById("getUser");
  const getAllMessage = document.getElementById("messages");
  var myHeaders = new Headers();
  myHeaders.append("Authorization", "Bearer " + token);

  var requestOptions = {
    method: "GET",
    headers: myHeaders,
    redirect: "follow",
  };
  //lay thong tin nguoi dung
  fetch("http://10.2.44.52:8888/api/user/info", requestOptions)
    .then((response) => {
      return response.json();
    })
    .then((result) => {
      console.log("result", result);

      if (result.status == 1) {
        fullName.textContent = result.data.FullName;
        avatar.src = "http://10.2.44.52:8888/api/images" + result.data.Avatar;
      } else {
        console.error("Error: " + result.message);
      }
    })
    .catch((error) => console.log("error", error));

  //su kien dang xuat
  const btnLogout = document.getElementById("logout");
  btnLogout.addEventListener("click", function () {
    event.preventDefault();
    localStorage.clear();
    window.location.href = "/auth/login.html";
  });

  //lấy danh sách bạn bè
  fetch("http://10.2.44.52:8888/api/message/list-friend", requestOptions)
    .then((response) => response.json())
    .then((result) => {
      console.log("Result:", result);
      if (result.status == 1) {
        result.data.forEach((friend) => {
          const listItem = document.createElement("div");
          listItem.classList.add("leftContainerChannel");
          listItem.dataset.friend = JSON.stringify(friend);

          const avatar = document.createElement("img");
          avatar.classList.add("avatar");
          avatar.src = "http://10.2.44.52:8888/api/images" + friend.Avatar;
          listItem.appendChild(avatar);

          const friendInfo = document.createElement("div");
          friendInfo.classList.add("leftContainerChannelInfor");

          const fullName = document.createElement("p");
          fullName.classList.add("content");
          fullName.textContent = friend.FullName;
          friendInfo.appendChild(fullName);

          fetch(
            "http://10.2.44.52:8888/api/message/get-message?FriendID=" +
              friend.FriendID,
            requestOptions
          )
            .then((response1) => {
              return response1.json();
            })
            .then((result1) => {
              console.log("result1", result1);
              fetch(
                "http://10.2.44.52:8888/api/message/get-message?FriendID=" +
                  friend.FriendID +
                  "&&LastTime=" +
                  result1.data.LastTime,
                requestOptionss
              )
                .then((response2) => {
                  return response2.json();
                })
                .then((result2) => {
                  console.log("result", result2);
                  if (result2.status == 1) {
                    const lastMessage = document.createElement("p");
                    lastMessage.classList.add("content");
                    lastMessage.textContent = result2.data.Content;
                    friendInfo.appendChild(lastMessage);
                  } else {
                    console.error("Error: " + result2.message);
                  }
                })
                .catch((error) => console.log("error", error));
            })
            .catch((error2) => console.log("error", error2));

          // const status = document.createElement('p');
          // status.classList.add('status');
          // status.textContent = friend.isOnline ? 'Online' : 'Offline';
          // status.classList.add(friend.isOnline ? 'online' : 'offline');
          // friendInfo.appendChild(status);

          listItem.appendChild(friendInfo);
          friendsList.appendChild(listItem);
        });
      } else {
        console.error("Error: " + result.message);
      }
    })
    .catch((error) => {
      console.error("Error fetching friends list:", error);
    });

  //su kien click vao ban be
  friendsList.addEventListener("click", function (event) {
    if ( event.target &&event.target.classList.contains("leftContainerChannel"))
    {
      // Lấy thông tin về friend từ phần tử cha
      const friend = event.target.dataset.friend;
      friendClick(JSON.parse(friend));
      const friendID = JSON.parse(friend).FriendID;
      //lay tin nhan
      fetch(
        "http://10.2.44.52:8888/api/message/get-message?FriendID=" + friendID,
        requestOptions
      )
        .then((response) => {
          return response.json();
        })
        .then((result) => {
          console.log("result", result);
          if (result.status == 1) {
            result.data.forEach((message) => {
              const listMessage = document.createElement("div");
              if (message.MessageType == 0) {
                listMessage.classList.add("rightContainerListMessageFriend");

                const avatar = document.createElement("img");
                avatar.classList.add("avatarMessage");
                avatar.src =
                  "http://10.2.44.52:8888/api/images" + JSON.parse(friend).Avatar;
                listMessage.appendChild(avatar);

                const content = document.createElement("p");
                content.classList.add("friendMessage");
                content.textContent = message.Content;

                listMessage.appendChild(content);
                getAllMessage.appendChild(listMessage);
              } else {
                listMessage.classList.add("rightContainerListMyMessage");
                const content = document.createElement("p");
                content.classList.add("myMessage");
                content.textContent = message.Content;

                listMessage.appendChild(content);
                getAllMessage.appendChild(listMessage);
              }
            });
          } else {
            console.error("Error: " + result.message);
          }
        })
        .catch((error) => console.log("error", error));
    }
    //chon ban de nhan tin
    const boxes = document.querySelectorAll(".leftContainerChannel");
    boxes.forEach((box) => {
      box.addEventListener("click", function () {
        boxes.forEach((box) => {
          box.classList.remove("active");
        });
        this.classList.add("active");
      });
    });
  });
  // lay user
  function friendClick(friend) {
    const existingUser = getUser.querySelector(".rightContainerHeader");
    if (existingUser) {
      existingUser.remove();
    }
    const existingFriendMessage = getAllMessage.querySelectorAll(
      ".rightContainerListMessageFriend"
    );
    existingFriendMessage.forEach((message) => {
      message.remove();
    });
    const existingMyMessage = getAllMessage.querySelectorAll(
      ".rightContainerListMyMessage"
    );
    existingMyMessage.forEach((message) => {
      message.remove();
    });
    const userInfor = document.createElement("div");
    userInfor.classList.add("rightContainerHeader");

    const avatar = document.createElement("img");
    avatar.classList.add("rightContainerHeaderAvatar");
    avatar.src = "http://10.2.44.52:8888/api/images" + friend.Avatar;
    userInfor.appendChild(avatar);

    const detailDiv = document.createElement("div");
    detailDiv.classList.add("rightContainerHeaderInfor");

    const fullName = document.createElement("p");
    fullName.classList.add("rightContainerHeaderUserName");
    fullName.textContent = friend.FullName;
    detailDiv.appendChild(fullName);

    const status = document.createElement("p");
    status.textContent = friend.isOnline ? "Online" : "Offline";
    status.classList.add("rightContainerHeaderUserName");
    detailDiv.appendChild(status);

    userInfor.appendChild(detailDiv);
    getUser.appendChild(userInfor);
  }
</script>
